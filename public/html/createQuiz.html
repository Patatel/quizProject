<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Créer un Quiz</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <header class="navbar">
        <h1>Créer un nouveau Quiz</h1>
        <nav>
            <button onclick="window.location.href='home.html'">Accueil</button>
            <button onclick="window.location.href='my_quizzes.html'">Mes Quiz</button>
        </nav>
    </header>

    <main>
        <form id="quiz-form">
            <label for="title">Titre du Quiz :</label>
            <input type="text" id="title" name="title" required>

            <label for="description">Description :</label>
            <textarea id="description" name="description" rows="4" required></textarea>

            <button type="submit">Créer le Quiz</button>
            <p id="message"></p>
        </form>
        <section>
            <h2>Ajouter des Questions</h2>
            <input type="hidden" id="quiz-id" />
            <form id="question-form">
                <div id="questions-container"></div>
                <button type="button" onclick="addQuestion()">Ajouter une question</button>
                <button type="submit">Enregistrer les questions</button>
            </form>
        </section>

    </main>
    <script>
        let questionCount = 0;

        function addQuestion(initialText = "") {
            if (questionCount >= 10) return alert("Maximum 10 questions");
            questionCount++;

            const container = document.getElementById("questions-container");
            
            const questionDiv = document.createElement("div");
            questionDiv.className = "question-item";
            questionDiv.style.marginBottom = "20px";

            // Question input
            const input = document.createElement("input");
            input.type = "text";
            input.name = "question";
            input.required = true;
            input.placeholder = `Question ${questionCount}`;
            input.value = initialText;
            input.style.marginBottom = "10px";
            questionDiv.appendChild(input);

            // Answers container
            const answersDiv = document.createElement("div");
            answersDiv.className = "answers-container";
            answersDiv.style.marginLeft = "20px";

            // Add 4 answer fields
            for (let i = 0; i < 4; i++) {
                const answerDiv = document.createElement("div");
                answerDiv.style.marginBottom = "5px";

                const answerInput = document.createElement("input");
                answerInput.type = "text";
                answerInput.name = `answer_${questionCount}_${i}`;
                answerInput.required = true;
                answerInput.placeholder = `Réponse ${i + 1}`;

                const correctRadio = document.createElement("input");
                correctRadio.type = "radio";
                correctRadio.name = `correct_${questionCount}`;
                correctRadio.value = i;
                if (i === 0) correctRadio.checked = true;

                const label = document.createElement("label");
                label.textContent = "Correcte";

                answerDiv.appendChild(answerInput);
                answerDiv.appendChild(correctRadio);
                answerDiv.appendChild(label);
                answersDiv.appendChild(answerDiv);
            }

            questionDiv.appendChild(answersDiv);
            container.appendChild(questionDiv);
            container.appendChild(document.createElement("br"));
        }

        // Modify the question form submission to include answers
        document.getElementById("question-form").addEventListener("submit", async (e) => {
            e.preventDefault();

            const quizId = document.getElementById("quiz-id")?.value;
            if (!quizId) return alert("Quiz non identifié");

            const questionItems = document.querySelectorAll(".question-item");
            const questions = [];

            questionItems.forEach((item, questionIndex) => {
                const questionInput = item.querySelector("input[name='question']");
                const answerInputs = item.querySelectorAll("input[type='text'][name^='answer_']");
                const correctRadio = item.querySelector("input[type='radio']:checked");

                const answers = Array.from(answerInputs).map(input => input.value.trim());
                const correctAnswerIndex = parseInt(correctRadio.value);

                questions.push({
                    text: questionInput.value.trim(),
                    answers: answers,
                    correctAnswerIndex: correctAnswerIndex
                });
            });

            if (questions.length < 1 || questions.length > 10) {
                return alert("Veuillez saisir entre 1 et 10 questions.");
            }

            try {
                const response = await fetch("http://localhost/quizProject/api/route.php?route=add_questions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ quiz_id: quizId, questions })
                });

                const result = await response.json();

                if (response.ok) {
                    alert("Questions ajoutées !");
                    window.location.href = "quiz.html";
                } else {
                    alert(result.error || "Erreur lors de l'enregistrement des questions.");
                }
            } catch (err) {
                alert("Erreur réseau.");
            }
        });
    </script>

    <script>
        document.getElementById("quiz-form").addEventListener("submit", async function (event) {
            event.preventDefault();

            const title = document.getElementById("title").value;
            const description = document.getElementById("description").value;
            const userId = 1; // À remplacer par l'ID réel depuis la session

            try {
                const response = await fetch('http://localhost/quizProject/api/route.php?route=create_quiz', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, description, user_id: userId })
                });

                const result = await response.json();

                if (response.ok) {
                    const quizId = result.id;
                    document.getElementById("quiz-id").value = quizId; // <-- stocker l'ID pour l'ajout de questions
                    alert("Quiz créé ! Ajoutez maintenant vos questions.");
                } else {
                    document.getElementById("message").textContent = result.error || "Erreur lors de la création du quiz";
                }

            } catch (error) {
                document.getElementById("message").textContent = "Erreur réseau.";
            }
        });
    </script>
</body>

</html>